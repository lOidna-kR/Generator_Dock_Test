# 심전도 리듬 다양성 강화 (2025-11-03)

## 📋 문제 상황

### 이전 결과 (mcq_전문심장소생술_10개_20251103_001756.txt)
- **심실세동 6개 (60%)** ❌
- 목표: 10개 중 3회 이하
- 실제: 10개 중 6회 (2배 초과)

```
문제 1: 심실세동
문제 2: 심실세동
문제 4: 심실세동
문제 5: 심실세동
문제 9: 무맥성 심실빈맥
문제 10: 심실세동
```

### 추가 문제
- **등산 시나리오 4회** (문제 1, 4, 6, 10)
- 리듬 다양성 부족 (5가지만 사용, 목표: 8가지)

## 🎯 핵심 원인 분석

**사용자 피드백:**
> "리듬이 문제 논리 핵심아닌가?? 가장 중요한 부분이니 개선해줘"

**진단:**
1. 프롬프트의 리듬 다양성 규칙이 **너무 뒤에 위치**
2. "3회 이상 금지" → 실제로는 6회 생성 (규칙 무시)
3. 제약이 명확하지 않음 ("금지"보다 "최대 N개"가 더 명확)
4. 구체적인 예시 부족

## ✅ 해결 방법

### 1. 리듬 다양성 규칙을 **최우선 순위**로 이동

**변경 전:**
```
## 창의적으로 생성할 요소
### 1. 환자 케이스
### 2. 질문 논리
### 3. 심전도 리듬 (매우 중요!)  ← 3번째
```

**변경 후:**
```
## 창의적으로 생성할 요소
### 1. 심전도 리듬 (🔥 가장 중요! 최우선 준수 🔥)  ← 1번째!
### 2. 환자 케이스
### 3. 질문 논리
```

### 2. 제약을 더 엄격하고 명확하게 수정

**변경 전:**
```
- 같은 리듬 연속 2회 사용 절대 금지
- 같은 리듬 10개 중 3회 이상 사용 절대 금지
- 예: 심실세동 3개 이상 생성 금지
```

**변경 후:**
```
절대 금지 (엄격):
- ❌ 같은 리듬 연속 2회 사용 절대 금지
- ❌ 같은 리듬 10개 중 2회 초과 절대 금지 (최대 2개까지만!)
- ❌ 특히 심실세동은 2개까지만 (3개 이상 절대 금지)
- ❌ 예: 문제 1=심실세동, 문제 2=심실세동 → 즉시 중단!
```

**핵심 변경:**
- "3회 이상 금지" → **"2회 초과 금지 (최대 2개)"**
- 더 명확한 표현 사용

### 3. 13가지 리듬 목록 명시

**추가된 리듬 목록:**
```
- 심실세동 (VF)
- 무맥성 심실빈맥 (pulseless VT)
- 무수축 (Asystole)
- 무맥성 전기활동 (PEA) / 고칼륨혈증 PEA
- 발작성 상심실성 빈맥 (PSVT)
- 심방세동 (AF)
- 심실상성 빈맥
- 방실차단 (1도, 2도, 3도)
- 동서맥 (Sinus Bradycardia)
- 급성 심근경색 (STEMI)
- 폐색전증
- 저체온 관련 부정맥
- 자발순환 회복 후 (ROSC)
```

### 4. 구체적인 예시 추가

**올바른 예시:**
```
1. 심실세동 (VF)
2. 무수축 (Asystole) ✅
3. 무맥성 전기활동 (PEA) ✅
4. 발작성 상심실성 빈맥 (PSVT) ✅
5. 무맥성 심실빈맥 (pulseless VT) ✅
6. 심실세동 (VF) ⚠️ 두 번째 (OK, 더 이상 금지)
7. 동서맥 ✅
8. 급성 심근경색 (STEMI) ✅
9. 방실차단 ✅
10. 자발순환 회복 후 (ROSC) ✅
```

**잘못된 예시:**
```
1. 심실세동 ❌
2. 심실세동 ❌ 연속!
3. 무수축 ✅
4. 심실세동 ❌ 3번째!
```

### 5. 발생 장소 중복 제한 추가

```
발생 상황 (중복 제한):
- 절대 금지: 같은 장소 3회 이상 (예: 등산 3번 금지)
```

## 📊 기대 효과

### 개선 목표

| 항목 | 현재 (문제) | 목표 (개선) |
|------|-------------|-------------|
| **심실세동 개수** | 6개 (60%) | 최대 2개 (20%) |
| **리듬 종류** | 5가지 | 8~10가지 |
| **연속 중복** | 있음 (1→2) | 없음 |
| **등산 시나리오** | 4회 | 최대 2회 |

### 리듬 분포 목표 (10개 문제)

```
심실세동:           ■■ (2개)
무맥성 심실빈맥:    ■ (1개)
무수축:             ■ (1개)
PEA:                ■ (1개)
PSVT:               ■ (1개)
동서맥:             ■ (1개)
STEMI:              ■ (1개)
방실차단:           ■ (1개)
ROSC:               ■ (1개)
```

## 🔧 수정된 파일

1. `Data/Prompts/각론/전문심장소생술/system_prompt.txt`
   - 섹션 "### 1. 심전도 리듬 다양화" 추가 및 최우선 배치
   - 13가지 리듬 목록 명시
   - 제약 강화: "2회 초과 금지"
   - 예시 추가

2. `Data/Prompts/각론/전문심장소생술/retriever_prompt.txt`
   - 동일한 리듬 다양성 규칙 적용
   - 올바른/잘못된 예시 추가
   - 발생 장소 중복 제한 추가

## 📝 다음 단계

1. ✅ 프롬프트 수정 완료
2. ⏳ 테스트 실행: `python main.py` → 전문심장소생술 10개 생성
3. ⏳ 결과 평가:
   - 심실세동 개수 확인 (2개 이하?)
   - 리듬 종류 개수 확인 (8가지 이상?)
   - 연속 중복 확인 (없어야 함)
   - 등산 시나리오 확인 (2회 이하?)

## 🎓 핵심 교훈

1. **우선순위가 중요하다**
   - 가장 중요한 규칙은 프롬프트 앞쪽에 배치
   - 리듬은 전문심장소생술의 핵심 → 최우선 순위

2. **명확한 숫자가 효과적이다**
   - "3회 이상 금지" (모호) → "최대 2개까지" (명확)
   - "연속 금지" → "문제 1=VF → 문제 2≠VF" (구체적)

3. **예시가 중요하다**
   - 올바른 예시 + 잘못된 예시
   - LLM이 패턴을 더 잘 이해

4. **사용자 피드백이 핵심이다**
   - "리듬이 문제 논리 핵심" → 즉시 최우선 순위로 변경
   - 문제 정의가 정확하면 해결책도 명확함

---

**작성일:** 2025-11-03  
**작성자:** AI Assistant  
**관련 이슈:** 심실세동 6회 중복 (60% 과다)

