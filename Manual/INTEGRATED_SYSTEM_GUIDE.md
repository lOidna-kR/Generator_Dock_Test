# 통합 Generator System 가이드

## 📋 개요

통합 Generator System은 **Ask Mode (RAG 질의응답)**와 **Forge Mode (MCQ 생성)** 두 가지 기능을 자유롭게 전환하며 사용할 수 있는 시스템입니다.

## 🎯 모드 소개

### Ask Mode (RAG 질의응답)
- **기능**: 질문에 대한 답변 제공
- **방식**: 벡터 스토어 검색 → 관련 문서 추출 → LLM 기반 답변 생성
- **출력**: 답변 + 참고 문서 목록

### Forge Mode (MCQ 생성)
- **기능**: 객관식 문제 생성
- **방식**: 주제 선택 → 문서 검색 → Few-shot Learning → MCQ 생성
- **출력**: MCQ + 자동 저장 (Data/Result/)

## 🚀 시작하기

### 실행 방법

```bash
python main.py
```

### 초기 화면

```
======================================================================
🤖 통합 Generator System
======================================================================
💡 Ask Mode (RAG) + Forge Mode (MCQ)
======================================================================

🔍 설정 검증 중...
⚙️  컴포넌트 초기화 중...
✅ Generator 초기화 완료!

======================================================================
🎯 현재 모드: Ask Mode (RAG 질의응답)
======================================================================
모드:
  • Ask Mode  - 질문에 답변 (RAG)
  • Forge Mode - 문제 생성 (MCQ)

명령어:
  • /mode     - 모드 전환
  • /history  - 대화 히스토리 확인
  • /clear    - 히스토리 초기화
  • /save     - 세션 저장
  • /help     - 도움말
  • /quit     - 종료
======================================================================

💬 질문: 
```

### 🆕 통합 State 기능

**전역 State**로 모든 대화가 자동으로 저장됩니다:
- ✅ Ask Mode와 Forge Mode 대화 통합 관리
- ✅ 세션 히스토리 자동 추적
- ✅ 대화 컨텍스트 공유
- ✅ 세션 저장/로드 지원

## 📖 사용 가이드

### 공통 명령어

| 명령어 | 설명 |
|--------|------|
| `/mode` | 모드 전환 (Ask ↔ Forge) |
| `/history` | 대화 히스토리 확인 |
| `/clear` | 히스토리 초기화 |
| `/save` | 세션 저장 (JSON 파일) |
| `/help` | 도움말 표시 |
| `/quit`, `/exit`, `/q` | 프로그램 종료 |

### Ask Mode 사용법

**1. 질문 입력**
```
💬 질문: 심폐소생술의 압박 깊이는?
```

**2. 결과 확인**
```
🔍 '심폐소생술의 압박 깊이는?' 검색 중...

======================================================================
💬 답변
======================================================================
심폐소생술 시 가슴압박의 깊이는 성인의 경우 최소 5cm, 최대 6cm입니다.
소아의 경우 가슴 두께의 약 1/3 정도, 약 5cm 깊이로 압박합니다.

======================================================================
📚 참고 문서
======================================================================
  [1] 2026_양승아_응급처치학개론 - 총론 - 심폐소생술
  [2] 2026_양승아_응급처치학개론 - 각론 - 심정지
  [3] 2026_양승아_응급처치학개론 - 총론 - 기본소생술
```

**특징:**
- ✅ 자연어 질문 가능
- ✅ 실시간 벡터 검색
- ✅ 참고 문서 자동 표시
- ✅ 대화형 인터페이스

### Forge Mode 사용법

**1. 모드 전환**
```
💬 질문: /mode

======================================================================
🔄 모드 선택
======================================================================
  1. Ask Mode  - 질문에 답변 (RAG 질의응답)
  2. Forge Mode - 문제 생성 (MCQ 생성)
======================================================================
선택 (1 또는 2): 2

✅ Forge Mode로 전환되었습니다.
💡 주제를 입력하면 MCQ를 생성합니다.
```

**2. 🆕 대화 컨텍스트 활용** ⭐

최근 Ask Mode에서 나눈 대화를 기반으로 문제 생성 가능:

```
# Step 1: Ask Mode에서 질문
💬 질문: 심폐소생술의 압박 깊이는?
답변: 성인의 경우 5-6cm입니다...

💬 질문: 압박 속도는?
답변: 분당 100-120회입니다...

# Step 2: Forge Mode로 전환
💬 질문: /mode
선택: 2

# Step 3: 대화 기반 생성
📝 주제 (또는 명령어): 방금 대화 내용으로 문제 만들어줘

🔍 최근 대화 분석: 주제 '심폐소생술' 감지

🎯 '심폐소생술' 주제로 MCQ를 생성합니다...
[문제 생성됨 - 압박 깊이 관련]
```

**키워드:** "방금", "이전", "아까", "위에서", "대화", "최근"

**3. 문제 생성 옵션**

#### 옵션 1: 주제 기반 생성 (1개)
```
📝 주제 (또는 명령어): 심폐소생술

🎯 '심폐소생술' 주제로 MCQ를 생성합니다...

======================================================================
📝 생성된 MCQ (#1)
======================================================================

질문: 성인 심폐소생술 시 가슴압박의 올바른 깊이는?

1. 3-4cm
2. 5-6cm
3. 7-8cm
4. 9-10cm

✅ 정답: 2번

📖 해설:
  2번: 정답입니다. 성인의 경우 5-6cm 깊이로 압박합니다.
  ...

💾 자동 저장: Data\Result\mcq_심폐소생술_20251023_123456.txt
```

#### 옵션 2: 랜덤 생성 (1개)
```
📝 주제 (또는 명령어): random
또는
📝 주제 (또는 명령어): (Enter)
```

#### 옵션 3: 여러 개 생성
```
📝 주제 (또는 명령어): 10

🔄 랜덤으로 10개 MCQ를 생성합니다...

💡 중복 방지: 최근 3개 Chapter는 재선택하지 않습니다.

✅ 10개 MCQ 생성 완료!
💾 자동 저장: Data\Result\mcq_랜덤_10개_20251023_123456.txt
```

또는:
```
📝 주제 (또는 명령어): random 10
```

#### 옵션 4: 배치 생성
```
📝 주제 (또는 명령어): batch
생성할 MCQ 개수 (기본: 5): 20
```

**특징:**
- ✅ 자동 저장 (생성 즉시)
- ✅ 중복 방지 (최근 3개 Chapter)
- ✅ Few-shot Learning 적용
- ✅ 유효성 검증 자동

## 🔄 모드 전환 예시

### Ask → Forge 전환
```
💬 질문: /mode
선택 (1 또는 2): 2
✅ Forge Mode로 전환되었습니다.

📝 주제 (또는 명령어): 10
```

### Forge → Ask 전환
```
📝 주제 (또는 명령어): /mode
선택 (1 또는 2): 1
✅ Ask Mode로 전환되었습니다.

💬 질문: 응급의료체계란?
```

## 💬 히스토리 관리

### 히스토리 확인
```
💬 질문: /history

======================================================================
💬 대화 히스토리
======================================================================

[1] 💬 사용자 (16:30:15)
    심폐소생술의 압박 깊이는?

[2] 💬 AI (16:30:18)
    성인의 경우 5-6cm입니다...
    📚 출처: 3개 문서

[3] 📝 AI (16:31:20)
    문제: 성인 심폐소생술 시 가슴압박의 올바른 깊이는?

======================================================================
📊 통계: 질문 1개, MCQ 1개
======================================================================
```

### 히스토리 초기화
```
💬 질문: /clear
✅ 대화 히스토리가 초기화되었습니다.
```

### 세션 저장
```
💬 질문: /save

💾 세션 저장: Logs\session_20251023_163045.json
   질문 5개, MCQ 3개 저장됨
```

## 📂 출력 파일

### Forge Mode 저장 위치
```
Data/
  └── Result/
      ├── mcq_심폐소생술_20251023_123456.txt
      ├── mcq_랜덤_20251023_123457.txt
      └── mcq_랜덤_10개_20251023_123458.txt
```

### 파일 형식
```
======================================================================
MCQ 생성 결과
주제: 심폐소생술
생성 일시: 2025-10-23 12:34:56
총 문제 수: 1개
======================================================================

[문제 1]
----------------------------------------------------------------------

질문: ...

1. ...
2. ...
3. ...
4. ...

✅ 정답: 2번

📖 해설:
  1번: ...
  2번: ...
  ...

📋 출처: 2026_양승아_응급처치학개론 - 총론 - 심폐소생술

======================================================================
```

## 🛠️ 고급 기능

### 도움말 명령어
```
💬 질문: /help

======================================================================
📖 도움말
======================================================================
현재 모드: Ask Mode (RAG)

공통 명령어:
  /mode  - 모드 전환
  /help  - 도움말
  /quit  - 종료
  /exit  - 종료
  /q     - 종료

Ask Mode 사용법:
  • 질문 입력: 예) 심폐소생술의 압박 깊이는?
  • 자연어 질문 가능
  • 벡터 검색 기반 답변 생성
  • 참고 문서 자동 표시

======================================================================
```

## ⚙️ 시스템 구조

### 핵심 컴포넌트
```
main.py (통합 시스템)
  ├── Ask Mode Handler
  │   └── RAG_Generator (Core/Generator.py)
  │       ├── Vertex AI Vector Search
  │       ├── Gemini LLM
  │       └── 답변 생성 워크플로우
  │
  └── Forge Mode Handler
      └── MCQ_Generator (Core/MCQ_Generator.py)
          ├── 주제 선택
          ├── 문서 검색
          ├── Few-shot Learning
          ├── MCQ 생성
          └── 유효성 검증
```

### State 관리
```python
# MCQState에 execution_mode 추가
execution_mode: Literal["ask", "forge"]
```

## 🔍 트러블슈팅

### 문제 1: 초기화 실패
```
❌ 초기화 실패: ...
```
**해결 방법:**
1. `config.py` 설정 확인
2. Vertex AI 인증 확인
3. 환경 변수 확인 (.env)

### 문제 2: 벡터 검색 오류
```
❌ 오류: Vector Search failed
```
**해결 방법:**
1. Index ID 확인
2. Endpoint ID 확인
3. GCS Bucket 권한 확인

### 문제 3: MCQ 생성 실패
```
❌ 오류: MCQ generation failed
```
**해결 방법:**
1. Few-shot 데이터 확인 (Data/Few_Shot/)
2. 교재 구조 확인 (config.py)
3. 재시도 (자동 재시도 최대 6회)

## 📊 성능 최적화

### Ask Mode
- **응답 시간**: 2-5초
- **문서 수**: 5개 (조절 가능)
- **최적화**: 벡터 검색 캐싱

### Forge Mode
- **생성 시간**: 
  - 1개: 10-20초
  - 10개: 2-4분
  - 50개: 10-15분
- **최적화**: 배치 생성, 중복 방지

## 🎓 추가 리소스

- [프로젝트 README](PROJECT_README.md)
- [MCQ LangGraph 구조](MCQ_LANGGRAPH_README.md)
- [Few-shot 가이드](FEW_SHOT_GUIDE.md)
- [에러 처리 가이드](ERROR_HANDLING_GUIDE.md)

## 📞 지원

문제가 발생하면:
1. 로그 확인: `Logs/` 폴더
2. 설정 검증: `config.py`
3. 디버그 모드: `Utils/logging.py`

