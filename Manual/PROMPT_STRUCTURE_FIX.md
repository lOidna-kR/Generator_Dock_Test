# 프롬프트 구조 수정: 형태 고정 + 내용 다양성 강화

## 🔴 **발견된 문제**

### **요구사항 vs 실제 결과**

| 항목 | 요구사항 | 실제 결과 | 문제 |
|------|----------|----------|------|
| **형태** | 모방 (Few-shot과 동일) | 창의적 ([Image] 위치 변경) | ❌ 반대 |
| **내용** | 창의적 (다양한 케이스) | 모방 (동일한 논리) | ❌ 반대 |

### **구체적 예시**

**Few-shot:**
```
질문: "해당 심전도가 관찰되는 환자에게..."

[Image: "불규칙하고 미세한 파형" - "심실세동"]
```
- 형태: 질문 끝에 [Image]

**생성됨:**
```
질문: "[Image: "불규칙하고 미세한 파형" - "심실세동"]이 관찰된 환자에게..."
```
- 형태: [Image]를 질문 시작에 이동 ❌

---

## ✅ **해결 방안**

### **1. [Image] 위치 고정 (최우선)**

#### **system_prompt.txt 추가**
```markdown
### 1. [Image] 위치 및 형식 (매우 중요!)
- **Few-shot에 [Image]가 질문 끝 → 생성 시 질문 끝에 배치**
- **Few-shot에 [Image]가 <보기> 안 → 생성 시 <보기> 안에 배치**
- **절대 금지:** [Image]를 질문 시작 부분에 배치
- 형식: 반드시 `[Image: "파형 설명" - "진단명"]` 그대로 유지
```

#### **retriever_prompt.txt 추가**
```markdown
### 1. [Image] 위치 고정 (최우선 규칙!)

**예시: 질문 끝에 [Image]**
```
Few-shot: "...옳은 것은?\n\n[Image: ...]"
생성:     "...옳은 것은?\n\n[Image: ...]"  ✅
```

**절대 금지:**
```
Few-shot: "환자가 ... 질문?\n\n[Image: ...]"
생성:     "[Image: ...]이 관찰된 환자..."  ❌
```
```

---

### **2. 질문 구조 순서 고정**

```markdown
### 2. 질문 구조 순서
- Few-shot 순서를 정확히 따라야 함
- 예: "환자 상황 → 심전도 → 질문" 순서면 그대로
- 예: "질문 → [Image]" 순서면 그대로
```

---

### **3. 내용 다양성 극대화**

#### **환자 케이스 다양화**
```markdown
### 1. 환자 케이스 (반드시 예시와 달라야 함!)

**연령 다양화:**
- 예시: "40대" → 생성: "20대", "30대", "50대", "60대", "70대", "5세", "10세" 등
- **연속 2개 문제에서 같은 연령대 금지**

**성별 다양화:**
- 남성/여성/소아 균형있게 분포

**발생 상황:**
- 집, 직장, 운동 중, 등산, 수영장, 식당, 거리 등
- **매 문제마다 다른 상황**

**주 증상:**
- 흉통, 호흡곤란, 의식저하, 두근거림, 실신, 쓰러짐 등
- **같은 증상 연속 사용 금지**
```

#### **질문 논리 다양화**
```markdown
### 2. 질문 논리 (다양한 접근)

**다양한 질문 유형:**
- 약물: 선택 vs 용량 vs 투여 시기 vs 금기증
- 제세동: 적응증 vs 에너지 vs 순서 vs 시기
- 처치: 우선순위 vs 방법 vs 금기 vs 평가
- 진단: 질환 판단 vs 감별 vs 중증도 vs 예후

**통합적 사고:**
- 여러 개념을 조합한 복잡한 시나리오
- 단계별 의사결정 과정
- 합병증 발생 시 대응
```

#### **심전도 리듬 다양화**
```markdown
### 3. 심전도 리듬 다양화
- 심실세동, 무맥성 심실빈맥, 무수축, PEA
- 발작성 상심실성 빈맥, 심방세동
- 방실차단, 급성 심근경색
- **같은 리듬 연속 2회 이상 사용 절대 금지**
```

---

## 📊 **기대 효과**

### **Before (형태 창의적, 내용 모방)**
```
형태: [Image] 위치 자유 배치 → Few-shot과 다름
내용: "심실세동 → 제세동 → 약물" 반복 → Few-shot 복제

결과:
- 형태가 일관성 없음
- 내용이 반복됨
```

### **After (형태 고정, 내용 창의적)**
```
형태: [Image] 위치 정확히 복제 → Few-shot과 동일
내용: 다양한 연령/성별/상황/리듬/논리 → 매번 다름

결과:
- 형태가 일관성 있음
- 내용이 다양함
```

---

## 🎯 **핵심 메시지**

### **LLM에 전달되는 명확한 지시**

```
✅ 형태 복제 (100% 정확히)
   - [Image] 위치
   - 질문 구조 순서
   - <보기> 배치
   - 특수 형식

✅ 내용 창의적 (100% 새롭게)
   - 연령, 성별, 장소, 증상
   - 심전도 리듬
   - 질문 논리
   - 오답 보기
```

---

## ✅ 완료

- ✅ system_prompt.txt: [Image] 위치 고정 명시
- ✅ retriever_prompt.txt: 구조 순서 고정, 구체적 예시 추가
- ✅ 내용 다양성: 연령/성별/상황/리듬/논리 다양화 가이드 추가
- ✅ config.py: Few-shot 3개로 증가

**이제 형태는 정확히 복제하고, 내용은 매우 다양해질 것입니다!** 🎯

