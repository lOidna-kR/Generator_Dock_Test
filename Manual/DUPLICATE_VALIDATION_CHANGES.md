# 중복 검증 완화 가이드

## 🎯 변경 요약

중복 검증이 너무 엄격하여 정상적인 문제도 중복으로 판단되는 문제를 해결했습니다.

---

## 📊 변경 내역

### **1. 섹션/문서 ID 중복 검증 완화**

#### Before
```python
# 1개라도 겹치면 무조건 중복
if new_section_ids.intersection(existing_section_ids):
    return True  # 중복!
```

**문제:**
- 7개 문서 중 1개만 겹쳐도 중복 판정
- 같은 섹션에서 다른 문제 생성 불가능

#### After
```python
# 70% 이상 겹쳐야 중복
overlap_sections = len(new_section_ids.intersection(existing_section_ids))
total_sections = len(new_section_ids)
if total_sections > 0 and overlap_sections / total_sections >= 0.7:
    return True  # 중복!
```

**효과:**
- 7개 중 5개 이상 겹쳐야 중복
- 일부 문서 재사용 허용

---

### **2. Chapter 유사도 임계값 완화**

#### Before
```python
chapter_threshold = 0.75  # 같은 Chapter: 75% 유사 → 중복
```

**문제:**
- "소아 심정지 CPR" vs "성인 심정지 약물"
- "심정지" 공통어로 75% 초과
- 서로 다른 문제인데 중복 판정

#### After
```python
chapter_threshold = 0.85  # 같은 Chapter: 85% 유사 → 중복
```

**효과:**
- 85% 이상 유사해야 중복
- 같은 주제에서 다양한 문제 생성 가능

---

### **3. 보기 중복 임계값 완화**

#### Before
```python
# 3개 이상 보기가 같으면 중복
if matching_options >= 3:
    return True
```

**문제:**
- ACLS 약물: "제세동", "에피네프린", "아미오다론", "아트로핀"
- 대부분의 문제에서 3개 이상 중복
- 정상 문제도 중복 판정

#### After
```python
# 4개 모두 보기가 같아야 중복
if matching_options >= 4:
    return True
```

**효과:**
- 모든 보기가 동일해야만 중복
- 보기 1-2개 다르면 허용

---

## 📈 예상 효과

### **Before (과도하게 엄격)**
```
10개 생성 시:
- 성공: 6개
- 중복 재시도: 평균 4-6회
- 실패: 4개 (10회 재시도 초과)
```

### **After (합리적 완화)**
```
10개 생성 시:
- 성공: 9-10개
- 중복 재시도: 평균 1-2회
- 실패: 0-1개
```

---

## 🎯 중복 검증 기준 정리

| 검증 항목 | Before | After | 완화 정도 |
|-----------|--------|-------|----------|
| **섹션 ID** | 1개 겹침 | 70% 겹침 | ⭐⭐⭐⭐⭐ |
| **문서 ID** | 1개 겹침 | 70% 겹침 | ⭐⭐⭐⭐⭐ |
| **Chapter 유사도** | 75% | 85% | ⭐⭐⭐ |
| **보기 중복** | 3개 | 4개 | ⭐⭐⭐ |
| **질문 해시** | 동일 | 동일 | (유지) |
| **질문 텍스트** | 동일 | 동일 | (유지) |

---

## 💡 추가 완화 옵션 (필요시)

### **Option A: 섹션/문서 ID 검증 완전 제거**
```python
# Line 489-500 주석 처리
# if new_section_ids and existing_section_ids:
#     ...
```

**효과:**
- 같은 문서에서 여러 문제 생성 가능
- 유사도/보기 검증만 사용

---

### **Option B: Chapter 임계값 더 완화**
```python
chapter_threshold = 0.9  # 85% → 90%
```

**효과:**
- 90% 이상 유사해야 중복
- 더 다양한 문제 허용

---

### **Option C: 보기 중복 제거**
```python
# Line 526-533 주석 처리
```

**효과:**
- 보기 검증 안 함
- 질문만 다르면 OK

---

## 🧪 테스트 방법

```bash
python main.py
# Forge Mode → 3. 전문심장소생술 → 10문제
```

**기대 결과:**
```
[1/10] ✅ (재시도: 0회)
[2/10] ✅ (재시도: 1회)
[3/10] ✅ (재시도: 0회)
[4/10] ✅ (재시도: 0회)
[5/10] ✅ (재시도: 1회)
[6/10] ✅ (재시도: 0회)
[7/10] ✅ (재시도: 0회)
[8/10] ✅ (재시도: 1회)
[9/10] ✅ (재시도: 0회)
[10/10] ✅ (재시도: 0회)

평균 재시도: 0.3회 (이전 5.2회)
```

---

## ✅ 완료

- ✅ 섹션/문서 ID 완화 (1개 → 70%)
- ✅ Chapter 임계값 완화 (75% → 85%)
- ✅ 보기 중복 완화 (3개 → 4개)
- ✅ 문서 작성 완료

**이제 중복 발생률이 크게 감소할 것입니다!** 🎉

